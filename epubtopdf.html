<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Lector simple de EPUB</title>
<style>
  :root { --bg:#0b0c10; --card:#111318; --muted:#9aa3b2; --text:#e6e9ef; --accent:#7c9fff; }
  * { box-sizing:border-box; }
  body { margin:0; font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial; background:var(--bg); color:var(--text); display:flex; flex-direction:column; align-items:center; min-height:100vh; padding:20px;}
  h1 { margin:0 0 12px; font-size: clamp(20px, 4vw, 28px); text-align:center;}
  p.sub { margin:0; color:var(--muted); text-align:center; margin-bottom:20px;}
  .card { background: var(--card); border:1px solid #1b1e25; border-radius:16px; padding:20px; max-width:900px; width:100%; display:flex; gap:20px; flex-wrap:wrap;}
  .left { flex:1; display:flex; justify-content:center; align-items:flex-start;}
  .left img { max-width:150px; border-radius:12px; }
  .right { flex:2; display:flex; flex-direction:column; gap:10px; }
  .uploader { display:flex; gap:16px; align-items:center; justify-content:center; cursor:pointer; border:2px dashed #555; border-radius:12px; padding:20px; transition:0.3s; text-align:center;}
  .uploader.dragover { background:#1e1e1e; border-color:var(--accent);}
  .uploader input[type=file] { display:none;}
  .btn { display:inline-flex; align-items:center; gap:10px; padding:12px 20px; border-radius:12px; border:none; background:var(--accent); color:#0b0c10; cursor:pointer; font-weight:600; transition:0.3s; }
  .btn:hover { background:#99baff; }
  #status { color:var(--muted); font-size:14px; text-align:center; margin-top:10px; }
  #preview { margin-top:15px; background:#1b1e25; border-radius:12px; padding:10px; max-height:400px; overflow-y:auto; white-space:pre-wrap; font-family:serif; }
  footer { color:var(--muted); text-align:center; margin-top:40px; font-size:13px; }
</style>
</head>
<body>

<h1>📖 Lector EPUB</h1>
<p class="sub">Arrastra tu EPUB o haz clic para seleccionarlo. Podrás guardar el contenido como TXT o PDF.</p>

<div class="card">
  <div class="left">
    <img id="cover" alt="Portada del EPUB" hidden>
  </div>
  <div class="right">
    <label class="uploader" id="dropzone">
      Haz clic o arrastra tu EPUB aquí
      <input type="file" id="fileInput" accept=".epub">
    </label>
    <div style="display:flex; gap:10px; flex-wrap:wrap;">
      <button class="btn" id="txtBtn" disabled>Guardar Texto</button>
      <button class="btn" id="pdfBtn" disabled>Guardar PDF</button>
      <button class="btn" id="selectBtn" disabled>Seleccionar texto</button>
    </div>
    <div id="status"></div>

<!-- Indicador de lectura -->
<div id="readingIndicator" style="margin:10px 0; text-align:center; color:#9aa3b2; font-size:14px;">
  Progreso de lectura: <span id="progressPercent">0%</span>
</div>
    
  </div>
  <div id="preview"></div>  
</div>


<footer>Hecho con cariño 💙 — 100% en tu navegador</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
const dropzone = document.getElementById("dropzone");
const fileInput = document.getElementById("fileInput");
const txtBtn = document.getElementById("txtBtn");
const pdfBtn = document.getElementById("pdfBtn");
const selectBtn = document.getElementById("selectBtn");
const statusEl = document.getElementById("status");
const previewEl = document.getElementById("preview");
const coverEl = document.getElementById("cover");

let epubFile, textContent="";

dropzone.addEventListener("click", ()=>fileInput.click());
dropzone.addEventListener("dragover", e => { e.preventDefault(); dropzone.classList.add("dragover"); });
dropzone.addEventListener("dragleave", ()=>dropzone.classList.remove("dragover"));
dropzone.addEventListener("drop", e => { e.preventDefault(); dropzone.classList.remove("dragover"); handleFile(e.dataTransfer.files[0]); });
fileInput.addEventListener("change", e => handleFile(e.target.files[0]));

async function handleFile(file){
  if(!file || !file.name.endsWith(".epub")) return;
  epubFile = file;
  txtBtn.disabled = pdfBtn.disabled = selectBtn.disabled = true;
  previewEl.textContent = "";
  textContent = "";
  coverEl.hidden = true;
  statusEl.textContent = "Procesando EPUB...";

  const zip = await JSZip.loadAsync(await file.arrayBuffer());

  // Portada
  const coverName = Object.keys(zip.files).find(f=>/cover\.(jpg|jpeg|png)/i.test(f));
  if(coverName){
    const coverData = await zip.file(coverName).async("base64");
    coverEl.src = `data:image/jpeg;base64,${coverData}`;
    coverEl.hidden = false;
  }

  // Spine
  const opfFile = Object.keys(zip.files).find(f => f.endsWith(".opf"));
  if(!opfFile){ statusEl.textContent="No se encontró el archivo .opf"; return; }
  const opfContent = await zip.file(opfFile).async("string");
  const parser = new DOMParser();
  const opfDoc = parser.parseFromString(opfContent,"application/xml");

  const items = {};
  opfDoc.querySelectorAll("item").forEach(i=> items[i.getAttribute("id")] = i.getAttribute("href"));
  const spineIds = Array.from(opfDoc.querySelectorAll("spine itemref")).map(ir=>ir.getAttribute("idref"));
  const basePath = opfFile.replace(/[^\/]+$/,'');

  let accumulatedText = "";

  for(const id of spineIds){
    const href = items[id];
    if(href && zip.file(basePath+href)){
      const content = await zip.file(basePath+href).async("string");
      const tmp = document.createElement("div");
      tmp.innerHTML = content;
      accumulatedText += tmp.innerText + "\n\n";
    }
  }

  previewEl.textContent = accumulatedText;
  textContent = accumulatedText;
  statusEl.textContent = "Vista previa cargada ✅, Recarga la página para abrir otro libro.";
  txtBtn.disabled = pdfBtn.disabled = selectBtn.disabled = false;

// Desactivar/eliminar el uploader después de cargar el EPUB
dropzone.remove(); // quita el div por completo
  

// Restaurar progreso de lectura para este EPUB
await setReadingProgress(file);
  
}

// Descargar archivo
function downloadFile(filename, content){
  const a = document.createElement("a");
  a.href = URL.createObjectURL(new Blob([content],{type:"text/plain"}));
  a.download = filename;
  a.click();
}

txtBtn.addEventListener("click", ()=> downloadFile(epubFile.name.replace(".epub",".txt"), textContent));

pdfBtn.addEventListener("click", ()=>{
  statusEl.textContent = "Generando PDF... esto puede tardar";
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF('p','pt','a4');

  // Usar fuente sans-serif
  pdf.setFont("times");
  pdf.setFontSize(14);

  // 1️⃣ Agregar portada si existe
  if(!coverEl.hidden){
    const imgProps = pdf.getImageProperties(coverEl);
    const pdfWidth = pdf.internal.pageSize.getWidth() - 60; // margen 30
    const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
    pdf.addImage(coverEl, 'JPEG', 30, 40, pdfWidth, pdfHeight);
  }

  // 2️⃣ Comenzar texto debajo de la portada
  let y = coverEl.hidden ? 40 : (40 + ((pdf.internal.pageSize.getWidth() - 60) * coverEl.naturalHeight / coverEl.naturalWidth) + 20);

  const lines = pdf.splitTextToSize(textContent, 550); 
  lines.forEach(line=>{
    if(y > 780){ pdf.addPage(); y = 40; }
    pdf.text(30, y, line);
    y += 14;
  });

  pdf.save(epubFile.name.replace(".epub",".pdf"));
  statusEl.textContent = "PDF generado ✅";
});



  
const readingIndicator = document.getElementById("readingIndicator");
let epubHashKey = ""; // clave única para este EPUB

// Calcular hash del archivo EPUB
async function getFileHash(file) {
  const buffer = await file.arrayBuffer();
  const hashBuffer = await crypto.subtle.digest('SHA-256', buffer);
  const hashArray = Array.from(new Uint8Array(hashBuffer));
  return hashArray.map(b => b.toString(16).padStart(2,'0')).join('');
}

// Actualizar indicador visual
function updateIndicator(percent) {
  const rounded = Math.floor(percent * 100);
  readingIndicator.textContent = `Lectura: ${rounded}%`;
}

// Guardar progreso
function saveProgress(percent){
  if(epubHashKey) localStorage.setItem(epubHashKey, percent);
}

// Restaurar progreso al abrir EPUB
function restoreProgress(){
  if(!epubHashKey) return;
  const saved = parseFloat(localStorage.getItem(epubHashKey) || "0");
  previewEl.scrollTop = (previewEl.scrollHeight - previewEl.clientHeight) * saved;
  updateIndicator(saved);
}

// Actualizar mientras haces scroll
previewEl.addEventListener("scroll", ()=>{
  if(!epubHashKey) return;
  const percent = previewEl.scrollTop / (previewEl.scrollHeight - previewEl.clientHeight);
  saveProgress(percent);
  updateIndicator(percent);
});

// Inicializar progreso al cargar EPUB
async function setReadingProgress(file){
  epubHashKey = "epub-" + await getFileHash(file) + "-progress";
  restoreProgress();
}


// Calcular tiempo estimado de lectura
function estimatedReadingTime(text) {
    const words = text.trim().split(/\s+/).length; // cuenta palabras
    const wpm = 200; // palabras por minuto promedio
    const minutes = Math.ceil(words / wpm);
    return minutes;
}

// Actualizar indicador de lectura
function updateIndicator(percent) {
    const rounded = Math.floor(percent * 100);
    const time = estimatedReadingTime(textContent);
    readingIndicator.textContent = `Lectura: ${rounded}% | ≈ ${time} min`;
}

// Restaurar progreso si existe
function restoreProgress() {
    if(epubFile) {
        const savedProgress = localStorage.getItem(`epub-${epubFile.name}-progress`);
        if(savedProgress) {
            const scrollHeight = previewEl.scrollHeight - previewEl.clientHeight;
            previewEl.scrollTop = scrollHeight * parseFloat(savedProgress);
            updateIndicator(parseFloat(savedProgress));
        }
    }
}

// Guardar progreso y actualizar indicador mientras se hace scroll
previewEl.addEventListener("scroll", () => {
    const scrollTop = previewEl.scrollTop;
    const scrollHeight = previewEl.scrollHeight - previewEl.clientHeight;
    const scrollPercent = scrollTop / scrollHeight;
    if(epubFile) {
        localStorage.setItem(`epub-${epubFile.name}-progress`, scrollPercent);
    }
    updateIndicator(scrollPercent);
});

// Llamar al cargar EPUB
restoreProgress();

  


selectBtn.addEventListener("click", ()=> {
  const range = document.createRange();
  range.selectNode(previewEl);
  const sel = window.getSelection();
  sel.removeAllRanges();
  sel.addRange(range);
});
</script>

</body>
</html>
