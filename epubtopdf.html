<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Convertir EPUB a PDF</title>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background-color: #121212;
      color: #eee;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      margin: 0;
      padding: 20px;
    }
    h1 {
      color: #fff;
      margin-bottom: 20px;
    }
    .uploader {
      border: 2px dashed #555;
      border-radius: 12px;
      padding: 30px;
      text-align: center;
      width: 100%;
      max-width: 500px;
      transition: 0.3s;
      cursor: pointer;
    }
    .uploader.dragover {
      background-color: #1e1e1e;
      border-color: #4cafef;
    }
    .btn {
      margin-top: 20px;
      padding: 10px 20px;
      background: #4cafef;
      color: #121212;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      transition: 0.3s;
    }
    .btn:hover {
      background: #6dd5fa;
    }
    #status {
      margin-top: 15px;
      font-size: 14px;
      color: #aaa;
    }
  </style>
</head>
<body>
  <h1>ðŸ“– Convertir EPUB a PDF</h1>
  <div class="uploader" id="dropzone">
    Arrastra tu archivo EPUB aquÃ­ o haz click para seleccionarlo
    <input type="file" id="fileInput" accept=".epub" style="display:none">
  </div>
  <button class="btn" id="convertBtn" disabled>Convertir a PDF</button>
  <div id="status"></div>

  <!-- LibrerÃ­as necesarias -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <script>
    const dropzone = document.getElementById("dropzone");
    const fileInput = document.getElementById("fileInput");
    const convertBtn = document.getElementById("convertBtn");
    const statusEl = document.getElementById("status");
    let epubFile;

    // Drag & drop
    dropzone.addEventListener("click", () => fileInput.click());
    dropzone.addEventListener("dragover", e => {
      e.preventDefault();
      dropzone.classList.add("dragover");
    });
    dropzone.addEventListener("dragleave", () => dropzone.classList.remove("dragover"));
    dropzone.addEventListener("drop", e => {
      e.preventDefault();
      dropzone.classList.remove("dragover");
      epubFile = e.dataTransfer.files[0];
      if (epubFile && epubFile.name.endsWith(".epub")) {
        statusEl.textContent = `Archivo seleccionado: ${epubFile.name}`;
        convertBtn.disabled = false;
      }
    });
    fileInput.addEventListener("change", e => {
      epubFile = e.target.files[0];
      if (epubFile && epubFile.name.endsWith(".epub")) {
        statusEl.textContent = `Archivo seleccionado: ${epubFile.name}`;
        convertBtn.disabled = false;
      }
    });

    // ConversiÃ³n
    convertBtn.addEventListener("click", async () => {
      if (!epubFile) return;
      statusEl.textContent = "Procesando EPUB...";

      const JSZipInstance = new JSZip();
      const arrayBuffer = await epubFile.arrayBuffer();
      const zip = await JSZipInstance.loadAsync(arrayBuffer);

      // Buscar archivos XHTML/HTML dentro del EPUB
      const chapters = [];
      for (const filename of Object.keys(zip.files)) {
        if (filename.endsWith(".xhtml") || filename.endsWith(".html")) {
          const text = await zip.file(filename).async("string");
          chapters.push(text);
        }
      }

      if (!chapters.length) {
        statusEl.textContent = "No se encontraron capÃ­tulos legibles.";
        return;
      }

      statusEl.textContent = "Generando PDF... (esto puede tardar)";
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF({ unit: "pt", format: "a4" });

      for (let i = 0; i < chapters.length; i++) {
        const container = document.createElement("div");
        container.innerHTML = chapters[i];

        // renderizar cada capÃ­tulo como imagen y aÃ±adir al PDF
        const canvas = await html2canvas(container, { scale: 1 });
        const imgData = canvas.toDataURL("image/png");

        const pageWidth = pdf.internal.pageSize.getWidth();
        const pageHeight = pdf.internal.pageSize.getHeight();
        const ratio = Math.min(pageWidth / canvas.width, pageHeight / canvas.height);

        const imgWidth = canvas.width * ratio;
        const imgHeight = canvas.height * ratio;
        const x = (pageWidth - imgWidth) / 2;
        const y = 20;

        if (i > 0) pdf.addPage();
        pdf.addImage(imgData, "PNG", x, y, imgWidth, imgHeight);
      }

      pdf.save(epubFile.name.replace(".epub", ".pdf"));
      statusEl.textContent = "ConversiÃ³n completada âœ…";
    });
  </script>
</body>
</html>
