<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Lector EPUB</title>
<style>
:root { --bg:#0b0c10; --card:#111318; --muted:#9aa3b2; --text:#e6e9ef; --accent:#7c9fff; }
* { box-sizing:border-box; }
body { margin:0; font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial; background:var(--bg); color:var(--text); display:flex; flex-direction:column; align-items:center; min-height:100vh; padding:20px;}
h1 { margin:0 0 12px; font-size: clamp(20px, 4vw, 28px); text-align:center;}
p.sub { margin:0; color:var(--muted); text-align:center; margin-bottom:20px;}
.card { background: var(--card); border:1px solid #1b1e25; border-radius:16px; padding:20px; max-width:800px; width:100%;}
.uploader { display:flex; gap:16px; align-items:center; flex-wrap: wrap; justify-content:center; cursor:pointer; border:2px dashed #555; border-radius:12px; padding:20px; transition:0.3s; }
.uploader.dragover { background:#1e1e1e; border-color:var(--accent);}
.uploader input[type=file] { display:none;}
.btn { display:inline-flex; align-items:center; gap:10px; padding:12px 20px; border-radius:12px; border:none; background:var(--accent); color:#0b0c10; cursor:pointer; font-weight:600; margin-top:12px; transition:0.3s; }
.btn:hover { background:#99baff; }
#status { margin-top:12px; color:var(--muted); font-size:14px; text-align:center; }
#preview { margin-top:20px; background:#1b1e25; border-radius:12px; padding:10px; max-height:400px; overflow-y:auto; white-space:pre-wrap;}
#cover { max-width:200px; display:block; margin: 0 auto 20px auto; border-radius:12px; }
footer { color:var(--muted); text-align:center; margin-top:40px; font-size:13px; }
</style>
</head>
<body>
<h1>ðŸ“– Lector EPUB</h1>
<p class="sub">Arrastra tu EPUB o haz clic para seleccionarlo. VerÃ¡s la vista previa del texto.</p>

<div class="card">
  <img id="cover" alt="Portada del EPUB" hidden>
  <label class="uploader" id="dropzone">
    Haz clic o arrastra tu EPUB aquÃ­
    <input type="file" id="fileInput" accept=".epub">
  </label>
  <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:center; margin-top:10px;">
    <button class="btn" id="txtBtn" disabled>Generar TXT</button>
    <button class="btn" id="mdBtn" disabled>Generar MD</button>
    <button class="btn" id="pdfBtn" disabled>Generar PDF</button>
  </div>
  <div id="status"></div>
  <div id="preview"></div>
</div>

<footer>Hecho con cariÃ±o ðŸ’™ â€” 100% en tu navegador</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
const dropzone = document.getElementById("dropzone");
const fileInput = document.getElementById("fileInput");
const txtBtn = document.getElementById("txtBtn");
const mdBtn = document.getElementById("mdBtn");
const pdfBtn = document.getElementById("pdfBtn");
const statusEl = document.getElementById("status");
const previewEl = document.getElementById("preview");
const coverEl = document.getElementById("cover");

let epubFile, textContent="";

dropzone.addEventListener("click", ()=>fileInput.click());
dropzone.addEventListener("dragover", e => { e.preventDefault(); dropzone.classList.add("dragover"); });
dropzone.addEventListener("dragleave", ()=>dropzone.classList.remove("dragover"));
dropzone.addEventListener("drop", e => { e.preventDefault(); dropzone.classList.remove("dragover"); handleFile(e.dataTransfer.files[0]); });
fileInput.addEventListener("change", e => handleFile(e.target.files[0]));

async function handleFile(file){
  if(!file || !file.name.endsWith(".epub")) return;
  epubFile = file;
  txtBtn.disabled = mdBtn.disabled = pdfBtn.disabled = true;
  previewEl.textContent = "";
  textContent = "";
  coverEl.hidden = true;
  statusEl.textContent = "Procesando EPUB...";

  const zip = await JSZip.loadAsync(await file.arrayBuffer());
  const fileNames = Object.keys(zip.files);

  // Buscar portada (comÃºnmente cover.jpg o cover.png)
  const coverName = fileNames.find(f=>/cover\.(jpg|jpeg|png)/i.test(f));
  if(coverName){
    const coverData = await zip.file(coverName).async("base64");
    coverEl.src = `data:image/jpeg;base64,${coverData}`;
    coverEl.hidden = false;
  }

  let accumulatedText = "";

  for(const filename of fileNames){
    if(filename.endsWith(".xhtml") || filename.endsWith(".html")){
      const fileData = await zip.file(filename).async("string");
      const tmp = document.createElement("div");
      tmp.innerHTML = fileData;
      accumulatedText += tmp.innerText + "\n\n";
    }
  }

  if(!accumulatedText){
    statusEl.textContent = "No se pudo extraer texto del EPUB.";
    return;
  }

  previewEl.textContent = accumulatedText;
  textContent = accumulatedText;
  statusEl.textContent = "Vista previa cargada âœ…";

  txtBtn.disabled = mdBtn.disabled = pdfBtn.disabled = false;
}

// Descargar archivo
function downloadFile(filename, content){
  const a = document.createElement("a");
  a.href = URL.createObjectURL(new Blob([content],{type:"text/plain"}));
  a.download = filename;
  a.click();
}

// Botones
txtBtn.addEventListener("click", ()=>downloadFile(epubFile.name.replace(".epub",".txt"), textContent));
mdBtn.addEventListener("click", ()=>downloadFile(epubFile.name.replace(".epub",".md"), textContent));
pdfBtn.addEventListener("click", ()=>{
  statusEl.textContent = "Generando PDF...";
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF();
  const lines = pdf.splitTextToSize(textContent, 180);
  pdf.text(lines, 15, 20);
  pdf.save(epubFile.name.replace(".epub",".pdf"));
  statusEl.textContent = "PDF generado âœ…";
});
</script>
</body>
</html>
