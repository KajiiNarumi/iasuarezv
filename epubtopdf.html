<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Lector EPUB</title>
<style>
  :root { --bg:#0b0c10; --card:#111318; --muted:#9aa3b2; --text:#e6e9ef; --accent:#7c9fff; }
  * { box-sizing:border-box; }
  body { margin:0; font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial; background:var(--bg); color:var(--text); display:flex; flex-direction:column; align-items:center; min-height:100vh; padding:20px;}
  h1 { margin:0 0 12px; font-size: clamp(20px, 4vw, 28px); text-align:center;}
  p.sub { margin:0; color:var(--muted); text-align:center; margin-bottom:20px;}
  .card { background: var(--card); border:1px solid #1b1e25; border-radius:16px; padding:20px; max-width:800px; width:100%;}
  .uploader { display:flex; gap:16px; align-items:center; flex-wrap: wrap; justify-content:center; cursor:pointer; border:2px dashed #555; border-radius:12px; padding:20px; transition:0.3s; }
  .uploader.dragover { background:#1e1e1e; border-color:var(--accent);}
  .uploader input[type=file] { display:none;}
  .btn { display:inline-flex; align-items:center; gap:10px; padding:12px 20px; border-radius:12px; border:none; background:var(--accent); color:#0b0c10; cursor:pointer; font-weight:600; margin-top:12px; transition:0.3s; }
  .btn:hover { background:#99baff; }
  #status { margin-top:12px; color:var(--muted); font-size:14px; text-align:center; }
  #preview { margin-top:20px; background:#1b1e25; border-radius:12px; padding:10px; max-height:400px; overflow-y:auto; white-space:pre-wrap;}
  footer { color:var(--muted); text-align:center; margin-top:40px; font-size:13px; }
</style>
</head>
<body>
<h1>ðŸ“– Lector EPUB</h1>
<p class="sub">Arrastra tu EPUB o haz clic para seleccionarlo. VerÃ¡s la vista previa del texto.</p>

<div class="card">
  <label class="uploader" id="dropzone">
    Haz clic o arrastra tu EPUB aquÃ­
    <input type="file" id="fileInput" accept=".epub">
  </label>
  <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:center; margin-top:10px;">
    <button class="btn" id="txtBtn" disabled>Generar TXT</button>
    <button class="btn" id="mdBtn" disabled>Generar MD</button>
    <button class="btn" id="pdfBtn" disabled>Generar PDF</button>
  </div>
  <div id="status"></div>
  <div id="preview"></div>
</div>

<footer>Hecho con cariÃ±o ðŸ’™ â€” 100% en tu navegador</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<script>
const dropzone = document.getElementById("dropzone");
const fileInput = document.getElementById("fileInput");
const txtBtn = document.getElementById("txtBtn");
const mdBtn = document.getElementById("mdBtn");
const pdfBtn = document.getElementById("pdfBtn");
const statusEl = document.getElementById("status");
const previewEl = document.getElementById("preview");
let epubFile, textContent="";

// Drag & Drop
dropzone.addEventListener("click", ()=>fileInput.click());
dropzone.addEventListener("dragover", e => { e.preventDefault(); dropzone.classList.add("dragover"); });
dropzone.addEventListener("dragleave", ()=>dropzone.classList.remove("dragover"));
dropzone.addEventListener("drop", e => { e.preventDefault(); dropzone.classList.remove("dragover"); handleFile(e.dataTransfer.files[0]); });
fileInput.addEventListener("change", e => handleFile(e.target.files[0]));

async function handleFile(file){
  if(!file || !file.name.endsWith(".epub")) return;
  epubFile = file;
  txtBtn.disabled = mdBtn.disabled = pdfBtn.disabled = true;
  previewEl.textContent = "";
  textContent = "";
  statusEl.textContent = "Procesando EPUB...";

  const zip = await JSZip.loadAsync(await file.arrayBuffer());
  const opfFile = Object.keys(zip.files).find(f => f.endsWith(".opf"));
  if(!opfFile){ statusEl.textContent="No se encontrÃ³ el archivo .opf"; return; }
  const opfContent = await zip.file(opfFile).async("string");
  const parser = new DOMParser();
  const opfDoc = parser.parseFromString(opfContent,"application/xml");

  const items = {};
  opfDoc.querySelectorAll("item").forEach(i=> items[i.getAttribute("id")] = i.getAttribute("href"));
  const spineIds = Array.from(opfDoc.querySelectorAll("spine itemref")).map(ir=>ir.getAttribute("idref"));
  const basePath = opfFile.replace(/[^\/]+$/,'');

  let accumulatedText = "";

  for(const id of spineIds){
    const href = items[id];
    if(href && zip.file(basePath+href)){
      const content = await zip.file(basePath+href).async("string");
      const tmp = document.createElement("div");
      tmp.innerHTML = content;
      accumulatedText += tmp.innerText + "\n\n";
    }
  }

  previewEl.textContent = accumulatedText;
  textContent = accumulatedText;
  statusEl.textContent = "Vista previa cargada âœ…";
  txtBtn.disabled = mdBtn.disabled = pdfBtn.disabled = false;
}

// FunciÃ³n para descargar archivo
function downloadFile(filename, content){
  const a = document.createElement("a");
  a.href = URL.createObjectURL(new Blob([content],{type:"text/plain"}));
  a.download = filename;
  a.click();
}

// Botones
txtBtn.addEventListener("click", ()=>{ downloadFile(epubFile.name.replace(".epub",".txt"), textContent); });
mdBtn.addEventListener("click", ()=>{ downloadFile(epubFile.name.replace(".epub",".md"), textContent); });
pdfBtn.addEventListener("click", ()=>{
  statusEl.textContent = "Generando PDF... esto puede tardar";
  const container = document.createElement("div");
  container.style.padding="20px";
  container.style.background="#fff";
  container.style.color="#000";
  container.style.fontFamily="serif";
  container.textContent = textContent;
  document.body.appendChild(container);

  const opt = {
    margin: [20,20,20,20],
    filename: epubFile.name.replace(".epub",".pdf"),
    image: { type: 'jpeg', quality:0.98 },
    html2canvas: { scale:2, logging:false },
    jsPDF: { unit:'pt', format:'a4', orientation:'portrait' }
  };
  html2pdf().set(opt).from(container).save().then(()=>{ container.remove(); statusEl.textContent="PDF generado âœ…"; });
});
</script>
</body>
</html>
