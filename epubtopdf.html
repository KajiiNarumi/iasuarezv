<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Lector EPUB â€” Guardar TXT, MD, PDF</title>
<style>
  :root { --bg:#0b0c10; --card:#111318; --muted:#9aa3b2; --text:#e6e9ef; --accent:#7c9fff; }
  * { box-sizing:border-box; }
  body { margin:0; font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial; background:var(--bg); color:var(--text); display:flex; flex-direction:column; align-items:center; min-height:100vh; padding:20px;}
  h1 { margin:0 0 12px; font-size: clamp(20px, 4vw, 28px); text-align:center;}
  p.sub { margin:0; color:var(--muted); text-align:center; margin-bottom:20px;}
  .card { background: var(--card); border:1px solid #1b1e25; border-radius:16px; padding:20px; max-width:900px; width:100%; display:flex; gap:20px; flex-wrap:wrap;}
  .left { flex:1; display:flex; justify-content:center; align-items:flex-start;}
  .left img { max-width:200px; border-radius:12px; }
  .right { flex:2; display:flex; flex-direction:column; gap:10px; }
  .uploader { display:flex; gap:16px; align-items:center; justify-content:center; cursor:pointer; border:2px dashed #555; border-radius:12px; padding:20px; transition:0.3s; text-align:center;}
  .uploader.dragover { background:#1e1e1e; border-color:var(--accent);}
  .uploader input[type=file] { display:none;}
  .btn { display:inline-flex; align-items:center; gap:10px; padding:12px 20px; border-radius:12px; border:none; background:var(--accent); color:#0b0c10; cursor:pointer; font-weight:600; transition:0.3s; }
  .btn:hover { background:#99baff; }
  #status { color:var(--muted); font-size:14px; text-align:center; margin-top:10px; }
  #preview { margin-top:20px; background:#1b1e25; border-radius:12px; padding:10px; max-height:400px; overflow-y:auto; white-space:pre-wrap; font-family:serif; }
  footer { color:var(--muted); text-align:center; margin-top:40px; font-size:13px; }
</style>
</head>
<body>

<h1>ðŸ“– Lector EPUB</h1>
<p class="sub">Arrastra tu EPUB o haz clic para seleccionarlo. PodrÃ¡s guardar el contenido como TXT, Markdown o PDF.</p>

<div class="card">
  <div class="left">
    <img id="cover" alt="Portada del EPUB" hidden>
  </div>
  <div class="right">
    <label class="uploader" id="dropzone">
      Haz clic o arrastra tu EPUB aquÃ­
      <input type="file" id="fileInput" accept=".epub">
    </label>
    <div style="display:flex; gap:10px; flex-wrap:wrap;">
      <button class="btn" id="txtBtn" disabled>Guardar Texto</button>
      <button class="btn" id="pdfBtn" disabled>Guardar PDF</button>
      <button class="btn" id="selectBtn" disabled>Seleccionar texto</button>
    </div>
    <div id="status"></div>
  </div>
  <div id="preview"></div>
</div>


<footer>Hecho con cariÃ±o ðŸ’™ â€” 100% en tu navegador</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
const dropzone = document.getElementById("dropzone");
const fileInput = document.getElementById("fileInput");
const txtBtn = document.getElementById("txtBtn");
const pdfBtn = document.getElementById("pdfBtn");
const selectBtn = document.getElementById("selectBtn");
const statusEl = document.getElementById("status");
const previewEl = document.getElementById("preview");
const coverEl = document.getElementById("cover");

let epubFile, textContent="";

dropzone.addEventListener("click", ()=>fileInput.click());
dropzone.addEventListener("dragover", e => { e.preventDefault(); dropzone.classList.add("dragover"); });
dropzone.addEventListener("dragleave", ()=>dropzone.classList.remove("dragover"));
dropzone.addEventListener("drop", e => { e.preventDefault(); dropzone.classList.remove("dragover"); handleFile(e.dataTransfer.files[0]); });
fileInput.addEventListener("change", e => handleFile(e.target.files[0]));

async function handleFile(file){
  if(!file || !file.name.endsWith(".epub")) return;
  epubFile = file;
  txtBtn.disabled = pdfBtn.disabled = selectBtn.disabled = true;
  previewEl.textContent = "";
  textContent = "";
  coverEl.hidden = true;
  statusEl.textContent = "Procesando EPUB...";

  const zip = await JSZip.loadAsync(await file.arrayBuffer());

  // Portada
  const coverName = Object.keys(zip.files).find(f=>/cover\.(jpg|jpeg|png)/i.test(f));
  if(coverName){
    const coverData = await zip.file(coverName).async("base64");
    coverEl.src = `data:image/jpeg;base64,${coverData}`;
    coverEl.hidden = false;
  }

  // Spine
  const opfFile = Object.keys(zip.files).find(f => f.endsWith(".opf"));
  if(!opfFile){ statusEl.textContent="No se encontrÃ³ el archivo .opf"; return; }
  const opfContent = await zip.file(opfFile).async("string");
  const parser = new DOMParser();
  const opfDoc = parser.parseFromString(opfContent,"application/xml");

  const items = {};
  opfDoc.querySelectorAll("item").forEach(i=> items[i.getAttribute("id")] = i.getAttribute("href"));
  const spineIds = Array.from(opfDoc.querySelectorAll("spine itemref")).map(ir=>ir.getAttribute("idref"));
  const basePath = opfFile.replace(/[^\/]+$/,'');

  let accumulatedText = "";

  for(const id of spineIds){
    const href = items[id];
    if(href && zip.file(basePath+href)){
      const content = await zip.file(basePath+href).async("string");
      const tmp = document.createElement("div");
      tmp.innerHTML = content;
      accumulatedText += tmp.innerText + "\n\n";
    }
  }

  previewEl.textContent = accumulatedText;
  textContent = accumulatedText;
  statusEl.textContent = "Vista previa cargada âœ…";
  txtBtn.disabled = pdfBtn.disabled = selectBtn.disabled = false;
}

// Descargar archivo
function downloadFile(filename, content){
  const a = document.createElement("a");
  a.href = URL.createObjectURL(new Blob([content],{type:"text/plain"}));
  a.download = filename;
  a.click();
}

txtBtn.addEventListener("click", ()=> downloadFile(epubFile.name.replace(".epub",".txt"), textContent));

pdfBtn.addEventListener("click", ()=>{
  statusEl.textContent = "Generando PDF... esto puede tardar";
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF('p','pt','a4');
  const lines = pdf.splitTextToSize(textContent, 550); 
  let y = 40;
  lines.forEach(line=>{
    if(y > 780){ pdf.addPage(); y = 40; }
    pdf.text(30, y, line);
    y += 14;
  });
  pdf.save(epubFile.name.replace(".epub",".pdf"));
  statusEl.textContent = "PDF generado âœ…";
});

selectBtn.addEventListener("click", ()=> {
  const range = document.createRange();
  range.selectNode(previewEl);
  const sel = window.getSelection();
  sel.removeAllRanges();
  sel.addRange(range);
});
</script>

</body>
</html>
