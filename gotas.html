---
layout: page
title: "Mis Gotas"
permalink: /gotas/
---
<h2>Fragmentos aforísticos</h2>
<div id="github-issues-feed">Cargando gotas...</div>
<div id="github-pagination" style="margin-top:2em;"></div>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<script>
const repo = "KajiiNarumi/iasuarezv";
const perPage = 10;
let currentPage = 1;
let isLoading = false;
let hasMore = true;

// --- Elementos del DOM ---
const feedElement = document.getElementById('github-issues-feed');
const paginationElement = document.getElementById('github-pagination');

// Inicializamos el div de paginación con el botón "Cargar Más"
paginationElement.innerHTML = `<button id="load-more-btn" onclick="loadIssues(currentPage + 1, true)">Cargando...</button>`;
const loadMoreBtn = document.getElementById('load-more-btn');

function escapeHtml(str) {
  if(!str) return "";
  return str
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}

function renderIssues(issues, append = false) {
  let html = "";
  if (issues.length === 0 && !append) {
    feedElement.innerHTML = "<p>No hay gotas aún.</p>";
    return;
  }

  issues.forEach(issue => {
    html += `
    <div class="note-issue" style="border:1px solid #eee; padding:1em; margin-bottom:2em;">
      <div>
        <span style="color:#888;">${new Date(issue.created_at).toLocaleString()}</span>
      </div>
      <h3 style="margin-top:0.5em;">${escapeHtml(issue.title)}</h3>
      <div>${issue.body ? marked.parse(issue.body) : ""}</div> 
      <div style="margin-top:1em;">
        <a href="${issue.html_url}" target="_blank">Comentar en GitHub</a>
      </div>
      <div class="issue-comments" id="comments-${issue.number}" style="margin-top:1em; font-size:0.9em; color:#444;">Cargando comentarios...</div>
    </div>
    `;

    // Cargar comentarios para cada issue
    fetch(`https://api.github.com/repos/${repo}/issues/${issue.number}/comments`)
      .then(r => r.json())
      .then(comments => {
        let commentHtml = "";
        if (comments.length === 0) {
          commentHtml = " ";
        } else {
          commentHtml = "<ul style='list-style:none;padding:0;'>";
          comments.forEach(comment => {
            commentHtml += `
            <li style="margin-bottom:0.8em;">
              <img src="${comment.user.avatar_url}" alt="${comment.user.login}" style="width:24px;border-radius:50%;vertical-align:middle;">
              <strong>${escapeHtml(comment.user.login)}</strong>
              <span style="color:#999;">${new Date(comment.created_at).toLocaleString()}</span>
              <div>${marked.parse(comment.body)}</div> 
            </li>`;
          });
          commentHtml += "</ul>";
        }
        document.getElementById(`comments-${issue.number}`).innerHTML = commentHtml;
      });
  });

  if (append) {
    feedElement.insertAdjacentHTML('beforeend', html);
  } else {
    feedElement.innerHTML = html;
  }
}

function updateLoadMoreButton() {
    if (loadMoreBtn) {
        if (isLoading) {
            loadMoreBtn.innerText = "Cargando...";
            loadMoreBtn.disabled = true;
        } else if (hasMore) {
            loadMoreBtn.innerText = "Cargar más gotas...";
            loadMoreBtn.disabled = false;
        } else {
            loadMoreBtn.innerText = "Fin de las gotas.";
            loadMoreBtn.disabled = true;
        }
    }
}

function loadIssues(page, append = false) {
  if (isLoading || (append && !hasMore)) return;

  isLoading = true;
  updateLoadMoreButton();

  if (append) {
    currentPage = page;
  }

  if (!append) {
    feedElement.innerHTML = "Cargando gotas...";
  }

  fetch(`https://api.github.com/repos/${repo}/issues?state=open&per_page=${perPage}&page=${currentPage}`)
    .then(r => r.json())
    .then(issues => {
      isLoading = false;
      renderIssues(issues, append);

      hasMore = issues.length === perPage;
      updateLoadMoreButton();
    })
    .catch(error => {
        isLoading = false;
        hasMore = false;
        updateLoadMoreButton();
        console.error("Error al cargar issues:", error);
    });
}

// ------------------------------------------
// Lógica de Scroll Infinito Automático
// ------------------------------------------
window.addEventListener('scroll', () => {
    const scrollThreshold = 500; 
    const nearBottom = (window.innerHeight + window.scrollY) >= (document.body.offsetHeight - scrollThreshold);

    if (nearBottom && !isLoading && hasMore) {
        loadIssues(currentPage + 1, true);
    }
});

// Inicializa la primera carga
window.loadIssues = loadIssues;
loadIssues(1);
</script>
