---
layout: page
title: "Mis Gotas"
permalink: /gotas/
---
<h2>Fragmentos aforísticos</h2>
<div id="github-issues-feed">Cargando gotas...</div>
<div id="github-pagination" style="margin-top:2em;"></div>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<script>
const repo = "KajiiNarumi/iasuarezv";
const perPage = 10;
let currentPage = 1;
let isLoading = false;
let hasMore = true;

// --- Elementos del DOM ---
const feedElement = document.getElementById('github-issues-feed');
const paginationElement = document.getElementById('github-pagination');

// Inicializamos el botón de "Cargar Más"
paginationElement.innerHTML = `<button id="load-more-btn" onclick="loadIssues(currentPage + 1, true)">Cargando...</button>`;
const loadMoreBtn = document.getElementById('load-more-btn');

// Función de seguridad para evitar inyección de código malicioso
function escapeHtml(str) {
  if(!str) return "";
  return str
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}

function renderIssues(issues, append = false) {
  let html = "";
  if (issues.length === 0 && !append) {
    feedElement.innerHTML = "<p>No hay gotas aún.</p>";
    return;
  }

  issues.forEach(issue => {
    html += `
    <div class="note-issue" style="border:1px solid #eee; padding:1em; margin-bottom:2em;">
      <div>
        <span style="color:#888;">${new Date(issue.created_at).toLocaleString()}</span>
      </div>
      <h3 style="margin-top:0.5em;">${escapeHtml(issue.title)}</h3>
      <div>${issue.body ? marked.parse(issue.body) : ""}</div> 
    </div>
    `;
    // **NOTA: Se eliminó todo el código relacionado con la carga de comentarios.**
  });

  if (append) {
    feedElement.insertAdjacentHTML('beforeend', html);
  } else {
    feedElement.innerHTML = html;
  }
}

function updateLoadMoreButton() {
    if (loadMoreBtn) {
        if (isLoading) {
            loadMoreBtn.innerText = "Cargando...";
            loadMoreBtn.disabled = true;
        } else if (hasMore) {
            loadMoreBtn.innerText = "Cargar más gotas...";
            loadMoreBtn.disabled = false;
        } else {
            loadMoreBtn.innerText = "Fin de las gotas.";
            loadMoreBtn.disabled = true;
        }
    }
}

function loadIssues(page, append = false) {
  if (isLoading || (append && !hasMore)) return;

  isLoading = true;
  updateLoadMoreButton();

  if (append) {
    currentPage = page;
  }

  if (!append) {
    feedElement.innerHTML = "Cargando gotas...";
  }

  fetch(`https://api.github.com/repos/${repo}/issues?state=open&per_page=${perPage}&page=${currentPage}`)
    .then(r => r.json())
    .then(issues => {
      isLoading = false;
      
      // Verificación de seguridad para la librería Markdown
      if (typeof marked === 'undefined' || !marked.parse) {
        throw new Error("Librería Marked.js no cargada.");
      }
      
      renderIssues(issues, append);

      hasMore = issues.length === perPage;
      updateLoadMoreButton();
    })
    .catch(error => {
        isLoading = false;
        hasMore = false;
        updateLoadMoreButton();
        console.error("Error al cargar issues:", error);
        feedElement.innerHTML = "<p>Ocurrió un error al intentar cargar las gotas. Por favor, intenta recargar la página.</p>";
    });
}

// ------------------------------------------
// Lógica de Scroll Infinito Automático
// ------------------------------------------
window.addEventListener('scroll', () => {
    const scrollThreshold = 500; 
    const nearBottom = (window.innerHeight + window.scrollY) >= (document.body.offsetHeight - scrollThreshold);

    if (nearBottom && !isLoading && hasMore) {
        loadIssues(currentPage + 1, true);
    }
});

// ------------------------------------------
// INICIALIZACIÓN (Asegura la carga después de Marked.js)
// ------------------------------------------
window.loadIssues = loadIssues;

document.addEventListener('DOMContentLoaded', () => {
    if (typeof marked !== 'undefined' && marked.parse) {
        loadIssues(1);
    } else {
        console.error("Error: marked.js no se cargó correctamente.");
        feedElement.innerHTML = "<p>Error: No se pudo cargar el módulo de formato de texto (Markdown).</p>";
        loadMoreBtn.style.display = 'none';
    }
});
</script>
